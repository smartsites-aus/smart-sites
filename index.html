<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Sites - Construction Site Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 60px;
            background: white;
            border-right: 1px solid #e9ecef;
            transition: width 0.3s ease;
            overflow: hidden;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar:hover {
            width: 240px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }

        .logo {
            font-size: 18px;
            font-weight: 500;
            color: #333;
            opacity: 0;
            transition: opacity 0.3s ease 0.1s;
        }

        .sidebar:hover .logo {
            opacity: 1;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #666;
            text-decoration: none;
            transition: all 0.2s ease;
            white-space: nowrap;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
        }

        .nav-link:hover {
            background: #f8f9fa;
            color: #333;
        }

        .nav-link.active {
            background: #e9ecef;
            color: #333;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .nav-text {
            opacity: 0;
            transition: opacity 0.3s ease 0.1s;
        }

        .sidebar:hover .nav-text {
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 60px;
            padding: 0;
            transition: margin-left 0.3s ease;
        }

        .page-content {
            display: none;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-content.active {
            display: block;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 300;
            color: #333;
        }

        .edit-btn {
            background: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }

        .edit-btn:hover {
            background: #222;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 500;
            color: #333;
        }

        .card-content {
            padding: 20px;
        }

        .card-content p {
            color: #666;
            margin-bottom: 10px;
            font-weight: 300;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 300;
            color: #333;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            font-weight: 300;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            min-width: 150px;
        }

        /* Device Grid */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .device-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .device-status {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .device-status.online {
            background: #28a745;
        }

        .device-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 10px;
        }

        .device-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .device-sensors {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .sensor-reading {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .sensor-name {
            color: #666;
        }

        .sensor-value {
            color: #333;
            font-weight: 500;
        }

        /* History Table */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .history-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 500;
            color: #333;
            border-bottom: 1px solid #e9ecef;
        }

        .history-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            color: #666;
        }

        .history-table tr:last-child td {
            border-bottom: none;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar:hover {
                transform: translateX(0);
                width: 240px;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .page-content {
                padding: 20px;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">Smart Sites</div>
            </div>
            <nav class="sidebar-nav">
                <button class="nav-link active" onclick="showPage('overview', event)">
                    <div class="nav-icon">üìä</div>
                    <span class="nav-text">Overview</span>
                </button>
                <button class="nav-link" onclick="showPage('devices', event)">
                    <div class="nav-icon">üì±</div>
                    <span class="nav-text">Devices</span>
                </button>
                <button class="nav-link" onclick="showPage('history', event)">
                    <div class="nav-icon">üìà</div>
                    <span class="nav-text">History</span>
                </button>
                <button class="nav-link" onclick="showPage('locations', event)">
                    <div class="nav-icon">üìç</div>
                    <span class="nav-text">Locations</span>
                </button>
                <button class="nav-link" onclick="showPage('automations', event)">
                    <div class="nav-icon">‚ö°</div>
                    <span class="nav-text">Automations</span>
                </button>
                <button class="nav-link" onclick="showPage('power', event)">
                    <div class="nav-icon">üîã</div>
                    <span class="nav-text">Power</span>
                </button>
                <button class="nav-link" onclick="showPage('reports', event)">
                    <div class="nav-icon">üìÑ</div>
                    <span class="nav-text">Reports</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Page -->
            <div class="page-content active" id="overview-page">
                <div class="page-header">
                    <h1 class="page-title">Overview</h1>
                    <button class="edit-btn" onclick="toggleEditMode()">
                        <span>‚úèÔ∏è</span>
                        <span>Edit Dashboard</span>
                    </button>
                </div>
                
                <div class="dashboard-grid" id="dashboard-grid">
                    <!-- Dashboard cards will be loaded here -->
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Welcome to Smart Sites</h3>
                    </div>
                    <div class="card-content">
                        <p>Your construction site management dashboard. Use the sidebar to navigate between different sections.</p>
                        <p>Click "Edit Dashboard" to customize your view and add monitoring cards.</p>
                    </div>
                </div>
            </div>

            <!-- Devices Page -->
            <div class="page-content" id="devices-page">
                <div class="page-header">
                    <h1 class="page-title">Devices</h1>
                    <button class="edit-btn" onclick="addDevice()">
                        <span>‚ûï</span>
                        <span>Add Device</span>
                    </button>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Location</label>
                        <select id="location-filter" onchange="filterDevices()">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Sensor Type</label>
                        <select id="sensor-type-filter" onchange="filterDevices()">
                            <option value="">All Types</option>
                            <option value="motion">Motion</option>
                            <option value="light">Light</option>
                            <option value="air_quality">Air Quality</option>
                            <option value="power">Power</option>
                        </select>
                    </div>
                </div>

                <div class="device-grid" id="device-grid">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì±</div>
                        <h3>No devices found</h3>
                        <p>Add devices to monitor your construction site.</p>
                    </div>
                </div>
            </div>

            <!-- History Page -->
            <div class="page-content" id="history-page">
                <div class="page-header">
                    <h1 class="page-title">History</h1>
                    <button class="edit-btn" onclick="exportHistory()">
                        <span>üì•</span>
                        <span>Export CSV</span>
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-content">
                        <table class="history-table" id="history-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Site Location</th>
                                    <th>Device Type</th>
                                    <th>Entity</th>
                                    <th>Old Value</th>
                                    <th>New Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                        No history data available yet.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Locations Page -->
            <div class="page-content" id="locations-page">
                <div class="page-header">
                    <h1 class="page-title">Site Locations</h1>
                    <button class="edit-btn" onclick="addLocation()">
                        <span>‚ûï</span>
                        <span>Add Location</span>
                    </button>
                </div>
                
                <div class="device-grid" id="locations-grid">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìç</div>
                        <h3>No locations configured</h3>
                        <p>Add site locations to organize your devices.</p>
                    </div>
                </div>
            </div>

            <!-- Automations Page -->
            <div class="page-content" id="automations-page">
                <div class="page-header">
                    <h1 class="page-title">Automations</h1>
                    <button class="edit-btn" onclick="createAutomation()">
                        <span>‚ûï</span>
                        <span>Create Automation</span>
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Automation Rules</h3>
                    </div>
                    <div class="card-content">
                        <p>Create automated responses to sensor data and environmental conditions.</p>
                        <p>Set up alerts, lighting controls, and safety monitoring rules for your construction site.</p>
                    </div>
                </div>
            </div>

            <!-- Power Page -->
            <div class="page-content" id="power-page">
                <div class="page-header">
                    <h1 class="page-title">Power Management</h1>
                    <button class="edit-btn" onclick="addPowerMeter()">
                        <span>‚ûï</span>
                        <span>Add CT Clamp</span>
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Power Consumption</h3>
                    </div>
                    <div class="card-content">
                        <p>Monitor real-time power consumption across your construction site using CT clamps and smart meters.</p>
                        <p>Track energy usage, identify power spikes, and optimize electrical efficiency.</p>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div class="page-content" id="reports-page">
                <div class="page-header">
                    <h1 class="page-title">Reports</h1>
                    <button class="edit-btn" onclick="generateReport()">
                        <span>üìä</span>
                        <span>Generate Report</span>
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Export Reports</h3>
                    </div>
                    <div class="card-content">
                        <p>Generate detailed reports for construction site monitoring data, energy consumption, and device performance.</p>
                        <p>Export data for regulatory compliance and project documentation.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const API_BASE = '/api';
        
        // State
        let editMode = false;
        let currentPage = 'overview';

        // Navigation - Fixed to properly handle events
        function showPage(pageId, event) {
            console.log('Switching to page:', pageId);
            
            // Hide all pages
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.remove('active'));
            
            // Show selected page
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Update active nav link
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            
            if (event && event.target) {
                const clickedLink = event.target.closest('.nav-link');
                if (clickedLink) {
                    clickedLink.classList.add('active');
                }
            }
            
            // Load page-specific data
            currentPage = pageId;
            loadPageData(pageId);
        }

        // Load page data
        async function loadPageData(pageId) {
            console.log('Loading data for page:', pageId);
            
            switch (pageId) {
                case 'overview':
                    await loadDashboardStats();
                    break;
                case 'devices':
                    await loadDevices();
                    break;
                case 'history':
                    await loadHistory();
                    break;
                case 'locations':
                    await loadLocations();
                    break;
                case 'automations':
                    await loadAutomations();
                    break;
                case 'power':
                    await loadPowerData();
                    break;
                case 'reports':
                    console.log('Reports page loaded');
                    break;
                default:
                    console.log('Unknown page:', pageId);
            }
        }

        // Dashboard functions
        async function loadDashboardStats() {
            try {
                // Try to fetch from API, but provide fallback for demo
                const response = await fetch(`${API_BASE}/dashboard-stats`);
                const stats = await response.json();
                
                const grid = document.getElementById('dashboard-grid');
                grid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_devices}</div>
                        <div class="stat-label">Total Devices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.online_devices}</div>
                        <div class="stat-label">Online Devices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_power}W</div>
                        <div class="stat-label">Power Consumption</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.recent_alerts}</div>
                        <div class="stat-label">Recent Alerts</div>
                    </div>
                `;
            } catch (error) {
                console.log('API not available, showing demo data');
                // Fallback demo data when API is not available
                const grid = document.getElementById('dashboard-grid');
                grid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Total Devices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Online Devices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0W</div>
                        <div class="stat-label">Power Consumption</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Recent Alerts</div>
                    </div>
                `;
            }
        }

        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.querySelector('.edit-btn');
            btn.innerHTML = editMode ? 
                '<span>üíæ</span><span>Save Dashboard</span>' : 
                '<span>‚úèÔ∏è</span><span>Edit Dashboard</span>';
            
            console.log('Edit mode:', editMode ? 'enabled' : 'disabled');
            alert(editMode ? 'Edit mode enabled! Dashboard customization coming soon.' : 'Edit mode disabled.');
        }

        // Device functions
        async function loadDevices() {
            try {
                const response = await fetch(`${API_BASE}/devices`);
                const devices = await response.json();
                renderDevices(devices);
            } catch (error) {
                console.log('Failed to load devices, showing empty state');
                // The empty state is already in the HTML
            }
        }

        function renderDevices(devices) {
            const grid = document.getElementById('device-grid');
            
            if (devices.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì±</div>
                        <h3>No devices found</h3>
                        <p>Add devices to monitor your construction site.</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = devices.map(device => `
                <div class="device-card">
                    <div class="device-status ${device.status === 'online' ? 'online' : ''}"></div>
                    <div class="device-name">${device.name}</div>
                    <div class="device-info">Type: ${device.type}</div>
                    <div class="device-info">Location: ${device.location}</div>
                    <div class="device-info">Last seen: ${device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never'}</div>
                    
                    <div class="device-sensors">
                        ${device.entities.map(entity => `
                            <div class="sensor-reading">
                                <span class="sensor-name">${entity.name}</span>
                                <span class="sensor-value">${entity.value}${entity.unit ? ' ' + entity.unit : ''}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function filterDevices() {
            console.log('Filtering devices...');
            loadDevices();
        }

        function addDevice() {
            alert('Add device functionality - connect your ESP32 sensors here!');
        }

        // History functions
        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/history`);
                const data = await response.json();
                
                const tbody = document.querySelector('#history-table tbody');
                tbody.innerHTML = data.history.map(entry => `
                    <tr>
                        <td>${new Date(entry.timestamp).toLocaleString()}</td>
                        <td>${entry.site_location}</td>
                        <td>${entry.device_type}</td>
                        <td>${entry.entity}</td>
                        <td>${entry.old_value || 'N/A'}</td>
                        <td>${entry.new_value}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.log('Failed to load history');
            }
        }

        function exportHistory() {
            alert('Export history to CSV - feature coming soon!');
        }

        // Location functions
        async function loadLocations() {
            try {
                const response = await fetch(`${API_BASE}/locations`);
                const locations = await response.json();
                
                const grid = document.getElementById('locations-grid');
                if (locations.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìç</div>
                            <h3>No locations configured</h3>
                            <p>Add site locations to organize your devices.</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = locations.map(location => `
                    <div class="device-card">
                        <div class="device-name">${location.name}</div>
                        <div class="device-info">${location.description}</div>
                        <div class="device-info">Devices: ${location.device_count}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.log('Failed to load locations');
            }
        }

        function addLocation() {
            const name = prompt('Enter location name:');
            if (name) {
                alert(`Location "${name}" would be added to the system.`);
                // In real implementation:
                // fetch(`${API_BASE}/locations`, {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ name, description: '' })
                // }).then(() => loadLocations());
            }
        }

        // Automation functions
        async function loadAutomations() {
            console.log('Loading automations...');
            // Automation loading logic would go here
        }

        function createAutomation() {
            alert('Automation builder - create smart rules for your construction site!');
        }

        // Power functions
        async function loadPowerData() {
            console.log('Loading power data...');
            // Power data loading logic would go here
        }

        function addPowerMeter() {
            alert('Add CT clamp for power monitoring - track electrical usage!');
        }

        // Reports functions
        function generateReport() {
            alert('Generate construction site reports - export data for compliance!');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Smart Sites app initialized');
            // Load initial page data
            loadPageData('overview');
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('JavaScript error:', e.error);
        });
    </script>
</body>
</html>
